<!DOCTYPE html>
<html lang="en">
  <head><meta charset="UTF-8"/>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="Notes for Mesa"/><meta name="keywords" content="GL, Eureka" /><link rel="alternate" href="/default" title="Eureka"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0" />
<link rel="canonical" href="https://lucmann.github.io/lib/mesa/"/>

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" /><script type="text/x-mathjax-config">
    MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
  </script>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0" />

<script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":"","latex":true};
</script>

    <title>Notes for Mesa - Eureka</title>
  <meta name="generator" content="Hexo 4.2.1"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="mobile-header-logo">
    <a href="/." class="logo">Eureka</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">Home
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">Archives
          </li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags
          </li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories
          </li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Eureka</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            Home
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            Archives
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            Tags
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/categories/">
            Categories
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/about/">
            About
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">Notes for Mesa
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2020-02-04
        </span></div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Build"><span class="toc-text">Build</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Dependencies"><span class="toc-text">Dependencies</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Off-screen-Demos"><span class="toc-text">Off-screen Demos</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Requisite"><span class="toc-text">Requisite</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OSMesa-Call-Graphs"><span class="toc-text">OSMesa Call Graphs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Three-Different-Build-Configuration-reference-to-meson-options-txt"><span class="toc-text">Three Different Build Configuration (reference to meson_options.txt)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Three-Different-Call-Paths"><span class="toc-text">Three Different Call Paths</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Context"><span class="toc-text">Context</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Draw"><span class="toc-text">Draw</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gallium-Based-GLX-Demos"><span class="toc-text">Gallium-Based GLX Demos</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gallium-Genbu"><span class="toc-text">Gallium Genbu</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Added-or-Modified-Sources-and-Build-Scripts"><span class="toc-text">Added or Modified Sources and Build Scripts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Trace"><span class="toc-text">Trace</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DRI-Based-GLX-Demos"><span class="toc-text">DRI-Based GLX Demos</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Loading"><span class="toc-text">Loading</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Contexts"><span class="toc-text">Contexts</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#gl-context"><span class="toc-text">gl_context</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#st-context"><span class="toc-text">st_context</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#draw-context"><span class="toc-text">draw_context</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vbo-context"><span class="toc-text">vbo_context</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#vbo-exec-vtx-init"><span class="toc-text">vbo_exec_vtx_init</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vbo-vs-vao"><span class="toc-text">vbo vs. vao</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dispatchers"><span class="toc-text">Dispatchers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Modules"><span class="toc-text">Modules</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#draw-xxx-stage"><span class="toc-text">draw_xxx_stage</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Auxiliary"><span class="toc-text">Auxiliary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Q-amp-A"><span class="toc-text">Q&amp;A</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#When-xlib-creates-pipe-screen-only-software-rasterizers-or-pipes’screen-are-created-And-llvmpipe-softpipe-virgl-swr-unexceptionally-are-software-rasterizers-or-virtual-GPU-Zink-is-in-brief-a-translator-from-OpenGL-to-Vulkan-and-implemented-as-Gallium-driver-So-why-only-software-pipes"><span class="toc-text">When xlib creates pipe screen, only software rasterizers or pipes’screen are created. And llvmpipe, softpipe, virgl, swr, unexceptionally, are software rasterizers or virtual GPU. Zink is, in brief, a translator from OpenGL to Vulkan and implemented as Gallium driver. So why only software pipes?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#libGL-so-is-not-built-until-glx-option-is-enabled-in-meson-options-txt"><span class="toc-text">libGL.so is not built until glx option is enabled in meson_options.txt.</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#What-role-do-DRM-DRI-and-Gallium-play-in-Mesa"><span class="toc-text">What role do DRM, DRI and Gallium play in Mesa?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#What-problems-are-encountered-when-you-build-mesa-on-the-WSL"><span class="toc-text">What problems are encountered when you build mesa on the WSL?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#When-glXInitialize-creates-the-Display-only-driswCreateDisplay-returns-successfully-Both-of-dri2CreateDisplay-and-driCreateDisplay-failed"><span class="toc-text">When __glXInitialize creates the Display, only driswCreateDisplay returns successfully. Both of dri2CreateDisplay and driCreateDisplay failed.</span></a></li></ol></li></ol></li></ol>
    </div>
  </div><div class="post-content"><p><a href="https://mesa3d.org/" target="_blank" rel="noopener">Mesa</a> is an open source implementation for OpenGL. Check <a href="https://gitlab.freedesktop.org/mesa/mesa" target="_blank" rel="noopener">repository</a> for its source code. There are something worth to learn about this project for a graphic driver developer.</p>
<h2 id="Build"><a href="#Build" class="headerlink" title="Build"></a>Build</h2><p>It’s good choice for exploring any project’s source code to start with its build script. So here is the start.</p>
<h3 id="Dependencies"><a href="#Dependencies" class="headerlink" title="Dependencies"></a>Dependencies</h3><p>Mesa is a highly configurable project that means it allows to customize your own particular components by command-line options or a pure text file(meson_options.txt).</p>
<p>Generally speaking, which dependencies are required is determined by your configuration. For example, the following configuration</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br></pre></td><td class="code"><pre><span class="line">option(</span><br><span class="line">  &#39;platforms&#39;,</span><br><span class="line">  type : &#39;array&#39;,</span><br><span class="line">  value : [&#39;x11&#39;],</span><br><span class="line">  choices : [</span><br><span class="line">    &#39;auto&#39;, &#39;x11&#39;, &#39;wayland&#39;, &#39;drm&#39;, &#39;surfaceless&#39;, &#39;haiku&#39;, &#39;android&#39;,</span><br><span class="line">    &#39;windows&#39;,</span><br><span class="line">  ],</span><br><span class="line">  description : &#39;window systems to support. If this is set to &#96;auto&#96;, all platforms applicable will be enabled.&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;dri3&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;disabled&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;true&#39;, &#39;false&#39;, &#39;disabled&#39;, &#39;enabled&#39;],</span><br><span class="line">  description : &#39;enable support for dri3&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;dri-drivers&#39;,</span><br><span class="line">  type : &#39;array&#39;,</span><br><span class="line">  value : [],</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;i915&#39;, &#39;i965&#39;, &#39;r100&#39;, &#39;r200&#39;, &#39;nouveau&#39;, &#39;swrast&#39;],</span><br><span class="line">  description : &#39;List of dri drivers to build. If this is set to auto all drivers applicable to the target OS&#x2F;architecture will be built&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;dri-drivers-path&#39;,</span><br><span class="line">  type : &#39;string&#39;,</span><br><span class="line">  value : &#39;&#39;,</span><br><span class="line">  description : &#39;Location to install dri drivers. Default: $libdir&#x2F;dri.&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;dri-search-path&#39;,</span><br><span class="line">  type : &#39;string&#39;,</span><br><span class="line">  value : &#39;&#39;,</span><br><span class="line">  description : &#39;Locations to search for dri drivers, passed as colon separated list. Default: dri-drivers-path.&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;gallium-drivers&#39;,</span><br><span class="line">  type : &#39;array&#39;,</span><br><span class="line">  value : [&#39;swrast&#39;],</span><br><span class="line">  choices : [</span><br><span class="line">    &#39;auto&#39;, &#39;kmsro&#39;, &#39;radeonsi&#39;, &#39;r300&#39;, &#39;r600&#39;, &#39;nouveau&#39;, &#39;freedreno&#39;,</span><br><span class="line">    &#39;swrast&#39;, &#39;v3d&#39;, &#39;vc4&#39;, &#39;etnaviv&#39;, &#39;tegra&#39;, &#39;i915&#39;, &#39;svga&#39;, &#39;virgl&#39;,</span><br><span class="line">    &#39;swr&#39;, &#39;panfrost&#39;, &#39;iris&#39;, &#39;lima&#39;, &#39;zink&#39;</span><br><span class="line">  ],</span><br><span class="line">  description : &#39;List of gallium drivers to build. If this is set to auto all drivers applicable to the target OS&#x2F;architecture will be built&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;gallium-extra-hud&#39;,</span><br><span class="line">  type : &#39;boolean&#39;,</span><br><span class="line">  value : false,</span><br><span class="line">  description : &#39;Enable HUD block&#x2F;NIC I&#x2F;O HUD status support&#39;,</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;gallium-vdpau&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;disabled&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;true&#39;, &#39;false&#39;, &#39;enabled&#39;, &#39;disabled&#39;],</span><br><span class="line">  description : &#39;enable gallium vdpau frontend.&#39;,</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;vdpau-libs-path&#39;,</span><br><span class="line">  type : &#39;string&#39;,</span><br><span class="line">  value : &#39;&#39;,</span><br><span class="line">  description : &#39;path to put vdpau libraries. defaults to $libdir&#x2F;vdpau.&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;gallium-xvmc&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;disabled&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;true&#39;, &#39;false&#39;, &#39;enabled&#39;, &#39;disabled&#39;],</span><br><span class="line">  description : &#39;enable gallium xvmc frontend.&#39;,</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;xvmc-libs-path&#39;,</span><br><span class="line">  type : &#39;string&#39;,</span><br><span class="line">  value : &#39;&#39;,</span><br><span class="line">  description : &#39;path to put xvmc libraries. defaults to $libdir.&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;gallium-omx&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;disabled&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;disabled&#39;, &#39;bellagio&#39;, &#39;tizonia&#39;],</span><br><span class="line">  description : &#39;enable gallium omx frontend.&#39;,</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;omx-libs-path&#39;,</span><br><span class="line">  type : &#39;string&#39;,</span><br><span class="line">  value : &#39;&#39;,</span><br><span class="line">  description : &#39;path to put omx libraries. defaults to omx-bellagio pkg-config pluginsdir.&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;gallium-va&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;disabled&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;true&#39;, &#39;false&#39;, &#39;enabled&#39;, &#39;disabled&#39;],</span><br><span class="line">  description : &#39;enable gallium va frontend.&#39;,</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;va-libs-path&#39;,</span><br><span class="line">  type : &#39;string&#39;,</span><br><span class="line">  value : &#39;&#39;,</span><br><span class="line">  description : &#39;path to put va libraries. defaults to $libdir&#x2F;dri.&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;gallium-xa&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;disabled&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;true&#39;, &#39;false&#39;, &#39;enabled&#39;, &#39;disabled&#39;],</span><br><span class="line">  description : &#39;enable gallium xa frontend.&#39;,</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;gallium-nine&#39;,</span><br><span class="line">  type : &#39;boolean&#39;,</span><br><span class="line">  value : false,</span><br><span class="line">  description : &#39;build gallium &quot;nine&quot; Direct3D 9.x frontend.&#39;,</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;gallium-opencl&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  choices : [&#39;icd&#39;, &#39;standalone&#39;, &#39;disabled&#39;],</span><br><span class="line">  value : &#39;disabled&#39;,</span><br><span class="line">  description : &#39;build gallium &quot;clover&quot; OpenCL frontend.&#39;,</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;opencl-spirv&#39;,</span><br><span class="line">  type : &#39;boolean&#39;,</span><br><span class="line">  value : false,</span><br><span class="line">  description : &#39;build gallium &quot;clover&quot; OpenCL frontend with SPIR-V binary support.&#39;,</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;d3d-drivers-path&#39;,</span><br><span class="line">  type : &#39;string&#39;,</span><br><span class="line">  value : &#39;&#39;,</span><br><span class="line">  description : &#39;Location of D3D drivers. Default: $libdir&#x2F;d3d&#39;,</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;vulkan-drivers&#39;,</span><br><span class="line">  type : &#39;array&#39;,</span><br><span class="line">  value : [],</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;amd&#39;, &#39;freedreno&#39;, &#39;intel&#39;],</span><br><span class="line">  description : &#39;List of vulkan drivers to build. If this is set to auto all drivers applicable to the target OS&#x2F;architecture will be built&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;shader-cache&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;auto&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;true&#39;, &#39;false&#39;, &#39;enabled&#39;, &#39;disabled&#39;],</span><br><span class="line">  description : &#39;Build with on-disk shader cache support&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;vulkan-icd-dir&#39;,</span><br><span class="line">  type : &#39;string&#39;,</span><br><span class="line">  value : &#39;&#39;,</span><br><span class="line">  description : &#39;Location relative to prefix to put vulkan icds on install. Default: $datadir&#x2F;vulkan&#x2F;icd.d&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;vulkan-overlay-layer&#39;,</span><br><span class="line">  type : &#39;boolean&#39;,</span><br><span class="line">  value : false,</span><br><span class="line">  description : &#39;Whether to build the vulkan overlay layer&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;vulkan-device-select-layer&#39;,</span><br><span class="line">  type : &#39;boolean&#39;,</span><br><span class="line">  value : false,</span><br><span class="line">  description : &#39;Whether to build the vulkan device select layer&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;shared-glapi&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;enabled&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;true&#39;, &#39;false&#39;, &#39;enabled&#39;, &#39;disabled&#39;],</span><br><span class="line">  description : &#39;Whether to build a shared or static glapi. Defaults to false on Windows, true elsewhere&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;gles1&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;enabled&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;true&#39;, &#39;false&#39;, &#39;enabled&#39;, &#39;disabled&#39;],</span><br><span class="line">  description : &#39;Build support for OpenGL ES 1.x&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;gles2&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;enabled&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;true&#39;, &#39;false&#39;, &#39;enabled&#39;, &#39;disabled&#39;],</span><br><span class="line">  description : &#39;Build support for OpenGL ES 2.x and 3.x&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;opengl&#39;,</span><br><span class="line">  type : &#39;boolean&#39;,</span><br><span class="line">  value : true,</span><br><span class="line">  description : &#39;Build support for OpenGL (all versions)&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;gbm&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;disabled&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;true&#39;, &#39;false&#39;, &#39;enabled&#39;, &#39;disabled&#39;],</span><br><span class="line">  description : &#39;Build support for gbm platform&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;glx&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;gallium-xlib&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;disabled&#39;, &#39;dri&#39;, &#39;xlib&#39;, &#39;gallium-xlib&#39;],</span><br><span class="line">  description : &#39;Build support for GLX platform&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;egl&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;disabled&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;true&#39;, &#39;false&#39;, &#39;enabled&#39;, &#39;disabled&#39;],</span><br><span class="line">  description : &#39;Build support for EGL platform&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;glvnd&#39;,</span><br><span class="line">  type : &#39;boolean&#39;,</span><br><span class="line">  value : false,</span><br><span class="line">  description : &#39;Enable GLVND support.&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">   &#39;glx-read-only-text&#39;,</span><br><span class="line">   type : &#39;boolean&#39;,</span><br><span class="line">   value : false,</span><br><span class="line">   description : &#39;Disable writable .text section on x86 (decreases performance)&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;llvm&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;disabled&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;true&#39;, &#39;false&#39;, &#39;enabled&#39;, &#39;disabled&#39;],</span><br><span class="line">  description : &#39;Build with LLVM support.&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;shared-llvm&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;disabled&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;true&#39;, &#39;false&#39;, &#39;enabled&#39;, &#39;disabled&#39;],</span><br><span class="line">  description : &#39;Whether to link LLVM shared or statically.&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;valgrind&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;disabled&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;true&#39;, &#39;false&#39;, &#39;enabled&#39;, &#39;disabled&#39;],</span><br><span class="line">  description : &#39;Build with valgrind support&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;libunwind&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;disabled&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;true&#39;, &#39;false&#39;, &#39;enabled&#39;, &#39;disabled&#39;],</span><br><span class="line">  description : &#39;Use libunwind for stack-traces&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;lmsensors&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;disabled&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;true&#39;, &#39;false&#39;, &#39;enabled&#39;, &#39;disabled&#39;],</span><br><span class="line">  description : &#39;Enable HUD lmsensors support.&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;build-tests&#39;,</span><br><span class="line">  type : &#39;boolean&#39;,</span><br><span class="line">  value : false,</span><br><span class="line">  description : &#39;Build unit tests. Currently this will build *all* unit tests, which may build more than expected.&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;install-intel-gpu-tests&#39;,</span><br><span class="line">  type : &#39;boolean&#39;,</span><br><span class="line">  value : false,</span><br><span class="line">  description : &#39;Build and install Intel unit tests which require the GPU.  This option is for developers and the Intel CI system only.&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;selinux&#39;,</span><br><span class="line">  type : &#39;boolean&#39;,</span><br><span class="line">  value : false,</span><br><span class="line">  description : &#39;Build an SELinux-aware Mesa&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;osmesa&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;none&#39;,</span><br><span class="line">  choices : [&#39;none&#39;, &#39;classic&#39;, &#39;gallium&#39;],</span><br><span class="line">  description : &#39;Build OSmesa.&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;osmesa-bits&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;8&#39;,</span><br><span class="line">  choices : [&#39;8&#39;, &#39;16&#39;, &#39;32&#39;],</span><br><span class="line">  description : &#39;Number of channel bits for OSMesa.&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;swr-arches&#39;,</span><br><span class="line">  type : &#39;array&#39;,</span><br><span class="line">  value : [&#39;avx&#39;, &#39;avx2&#39;],</span><br><span class="line">  choices : [&#39;avx&#39;, &#39;avx2&#39;, &#39;knl&#39;, &#39;skx&#39;],</span><br><span class="line">  description : &#39;Architectures to build SWR support for.&#39;,</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;shared-swr&#39;,</span><br><span class="line">  type : &#39;boolean&#39;,</span><br><span class="line">  value : true,</span><br><span class="line">  description : &#39;Whether to link SWR shared or statically.&#39;,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">option(</span><br><span class="line">  &#39;tools&#39;,</span><br><span class="line">  type : &#39;array&#39;,</span><br><span class="line">  value : [],</span><br><span class="line">  choices : [&#39;drm-shim&#39;, &#39;etnaviv&#39;, &#39;freedreno&#39;, &#39;glsl&#39;, &#39;intel&#39;, &#39;intel-ui&#39;, &#39;nir&#39;, &#39;nouveau&#39;, &#39;xvmc&#39;, &#39;lima&#39;, &#39;panfrost&#39;, &#39;all&#39;],</span><br><span class="line">  description : &#39;List of tools to build. (Note: &#96;intel-ui&#96; selects &#96;intel&#96;)&#39;,</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;power8&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;auto&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;true&#39;, &#39;false&#39;, &#39;enabled&#39;, &#39;disabled&#39;],</span><br><span class="line">  description : &#39;Enable power8 optimizations.&#39;,</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;xlib-lease&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;auto&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;true&#39;, &#39;false&#39;, &#39;enabled&#39;, &#39;disabled&#39;],</span><br><span class="line">  description : &#39;Enable VK_EXT_acquire_xlib_display.&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;glx-direct&#39;,</span><br><span class="line">  type : &#39;boolean&#39;,</span><br><span class="line">  value : true,</span><br><span class="line">  description : &#39;Enable direct rendering in GLX and EGL for DRI&#39;,</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;prefer-iris&#39;,</span><br><span class="line">  type : &#39;boolean&#39;,</span><br><span class="line">  value : true,</span><br><span class="line">  description : &#39;Prefer new Intel iris driver over older i965 driver&#39;</span><br><span class="line">)</span><br><span class="line">option(&#39;egl-lib-suffix&#39;,</span><br><span class="line">  type : &#39;string&#39;,</span><br><span class="line">  value : &#39;&#39;,</span><br><span class="line">  description : &#39;Suffix to append to EGL library name.  Default: none.&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;gles-lib-suffix&#39;,</span><br><span class="line">  type : &#39;string&#39;,</span><br><span class="line">  value : &#39;&#39;,</span><br><span class="line">  description : &#39;Suffix to append to GLES library names.  Default: none.&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;platform-sdk-version&#39;,</span><br><span class="line">  type : &#39;integer&#39;,</span><br><span class="line">  min : 25,</span><br><span class="line">  max : 28,</span><br><span class="line">  value : 25,</span><br><span class="line">  description : &#39;Android Platform SDK version. Default: Nougat version.&#39;</span><br><span class="line">)</span><br><span class="line">option(</span><br><span class="line">  &#39;zstd&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;true&#39;, &#39;false&#39;, &#39;enabled&#39;, &#39;disabled&#39;],</span><br><span class="line">  value : &#39;auto&#39;,</span><br><span class="line">  description : &#39;Use ZSTD instead of ZLIB in some cases.&#39;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>requires these programs or packages below pre-installed.</p>
<ul>
<li><p>Programs</p>
<ul>
<li>pkg-config</li>
<li>bison</li>
<li>flex</li>
</ul>
</li>
<li><p>Development Packages</p>
<ul>
<li>libdrm-dev</li>
<li>libx11-dev</li>
<li>libxext-dev</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meson build</span><br></pre></td></tr></table></figure>
<p>You can configure a minimal dependencies mesa given that WSL is not a desktop platform as the following my configuration result:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Message: Configuration summary:</span><br><span class="line"></span><br><span class="line">        prefix:          &#x2F;usr&#x2F;local</span><br><span class="line">        libdir:          lib&#x2F;x86_64-linux-gnu</span><br><span class="line">        includedir:      include</span><br><span class="line"></span><br><span class="line">        OpenGL:          yes (ES1: yes ES2: yes)</span><br><span class="line">        OSMesa:          no</span><br><span class="line"></span><br><span class="line">        GLX:             Xlib-based (Gallium)</span><br><span class="line"></span><br><span class="line">        EGL:             no</span><br><span class="line">        GBM:             no</span><br><span class="line">        EGL&#x2F;Vulkan&#x2F;VL platforms:   x11</span><br><span class="line"></span><br><span class="line">        Vulkan drivers:  no</span><br><span class="line"></span><br><span class="line">        llvm:            no</span><br><span class="line"></span><br><span class="line">        Gallium drivers: swrast</span><br><span class="line">        Gallium st:      mesa</span><br><span class="line">        HUD lmsensors:   no</span><br><span class="line"></span><br><span class="line">        Shared-glapi:    yes</span><br><span class="line"></span><br><span class="line">Build targets in project: 97</span><br></pre></td></tr></table></figure>
<p>As you see this configuration supports quite a few components which are essential for off-screen rendering. Once dependencies check passed fully you can begin to compile and install:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ninja -C build &amp;&amp; sudo ninja -C build install</span><br></pre></td></tr></table></figure>
<p>After compilation and installed as follow:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ls -l /usr/<span class="built_in">local</span>/lib/x86_64-linux-gnu</span><br><span class="line">total 159360</span><br><span class="line">lrwxrwxrwx 1 root root        10 Feb  7 17:13 libGL.so -&gt; libGL.so.1</span><br><span class="line">lrwxrwxrwx 1 root root        14 Feb  7 17:13 libGL.so.1 -&gt; libGL.so.1.5.0</span><br><span class="line">-rwxr-xr-x 1 root root 111044912 Feb  7 17:13 libGL.so.1.5.0</span><br><span class="line">lrwxrwxrwx 1 root root        14 Feb  7 17:13 libOSMesa.so -&gt; libOSMesa.so.8</span><br><span class="line">lrwxrwxrwx 1 root root        18 Feb  7 17:13 libOSMesa.so.8 -&gt; libOSMesa.so.8.0.0</span><br><span class="line">-rwxr-xr-x 1 root root  51541176 Feb  7 17:13 libOSMesa.so.8.0.0</span><br><span class="line">lrwxrwxrwx 1 root root        13 Feb  7 17:13 libglapi.so -&gt; libglapi.so.0</span><br><span class="line">lrwxrwxrwx 1 root root        17 Feb  7 17:13 libglapi.so.0 -&gt; libglapi.so.0.0.0</span><br><span class="line">-rwxr-xr-x 1 root root    337264 Feb  7 17:07 libglapi.so.0.0.0</span><br><span class="line">drwxr-xr-x 1 root root       512 Feb  7 17:13 pkgconfig</span><br></pre></td></tr></table></figure>
<p>NOTE:</p>
<ul>
<li>Mesa is installed in <code>/usr/local/lib/$(uname -p)-linux-gnu</code> by default. So you have to <code>ldconfig</code> so that your linker can find them.</li>
<li>libsoftpipe.a will be built but not installed.</li>
<li>meson build system will enable compiler’s <code>-g</code> flag by default unless you are building on the release branch.</li>
<li>if you have remodified the <strong>meson_options.txt</strong> and built once and now are about to reconfigure and rebuild, you need to run:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meson setup --wipe build</span><br></pre></td></tr></table></figure>
<h2 id="Off-screen-Demos"><a href="#Off-screen-Demos" class="headerlink" title="Off-screen Demos"></a>Off-screen Demos</h2><p>Now that mesa have been built and installed we can give a try to run an OGL application. Similarly without window system supportd on the WSL, <a href="https://mesa3d.org/osmesa.html" target="_blank" rel="noopener">off-screen rendering</a> is my choice. We can clone the mesa <a href="https://gitlab.freedesktop.org/mesa/demos" target="_blank" rel="noopener">demos</a> which includes a lot of demos besides off-screen demos. </p>
<h3 id="Requisite"><a href="#Requisite" class="headerlink" title="Requisite"></a>Requisite</h3><p>We need some more libraries besides libOSMesa and libGL before you can get these off-screen demos worked. They are:</p>
<ul>
<li><a href="https://gitlab.freedesktop.org/mesa/glu" target="_blank" rel="noopener">GLU</a></li>
<li>libm</li>
</ul>
<p>To build these demos:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc osdemo.c -o osdemo -g -I/home/luc/github/demos/src/util -lGL -lGLU -lOSMesa -lm</span><br></pre></td></tr></table></figure></p>
<p>The executable osdemo saves the rendered pixels as the portable pixmap format. You need to covert it to image format e.g. jpg. You may do this with <code>pnmtojpeg output.ppm &gt; output.jpg</code>.</p>
<div align=center><img src="/lib/mesa/osdemo.jpg" class="" title="osdemo"></div>

<h2 id="OSMesa-Call-Graphs"><a href="#OSMesa-Call-Graphs" class="headerlink" title="OSMesa Call Graphs"></a>OSMesa Call Graphs</h2><p>Mesa supports many features from software pipelines to hardware drivers. For example <a href="https://www.freedesktop.org/wiki/Software/gallium/" target="_blank" rel="noopener">Gallium</a>, it features with several software or hardware implementations which include the two software pipelines, softpipe and <a href="https://www.mesa3d.org/llvmpipe.html" target="_blank" rel="noopener">llvmpipe</a>. With the different pipes enabled will the calls walk in the different paths. </p>
<h3 id="Three-Different-Build-Configuration-reference-to-meson-options-txt"><a href="#Three-Different-Build-Configuration-reference-to-meson-options-txt" class="headerlink" title="Three Different Build Configuration (reference to meson_options.txt)"></a>Three Different Build Configuration (reference to <strong>meson_options.txt</strong>)</h3><div class="table-container">
<table>
<thead>
<tr>
<th>Option</th>
<th><em>platform</em></th>
<th><em>glx</em></th>
<th><em>dri-drivers</em></th>
<th><em>gallium-drivers</em></th>
<th><em>llvm</em></th>
<th><em>osmesa</em></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>llvmpipe</strong></td>
<td>x11</td>
<td>gallium-xlib</td>
<td></td>
<td>swrast</td>
<td>true</td>
<td>gallium</td>
</tr>
<tr>
<td><strong>softpipe</strong></td>
<td>x11</td>
<td>gallium-xlib</td>
<td></td>
<td>swrast</td>
<td>false</td>
<td>gallium</td>
</tr>
<tr>
<td><strong>tnl</strong></td>
<td>x11</td>
<td>gallium-xlib</td>
<td></td>
<td>swrast</td>
<td>true</td>
<td>classic</td>
</tr>
</tbody>
</table>
</div>
<h3 id="Three-Different-Call-Paths"><a href="#Three-Different-Call-Paths" class="headerlink" title="Three Different Call Paths"></a>Three Different Call Paths</h3><h4 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h4><div align=center><img src="/lib/mesa/OSMesaCreateContextExt.png" class="" title="context initialization"></div>

<p>NOTE: As for softpipe and llvmpipe <code>gl_api</code> and <code>gl_context</code> are created respectively while both of them are created in one path for the classic osmesa.</p>
<h4 id="Draw"><a href="#Draw" class="headerlink" title="Draw"></a>Draw</h4><div align=center><img src="/lib/mesa/PopMatrix.png" class="" title="draw command"></div>

<h2 id="Gallium-Based-GLX-Demos"><a href="#Gallium-Based-GLX-Demos" class="headerlink" title="Gallium-Based GLX Demos"></a>Gallium-Based GLX Demos</h2><p>If you want to know the full graphic stack of an OpenGL demo, you can not get rid of the window system. That is why I will try some GLX demos. Evidently GLX demos must depend on X11. You can cope with this problem by installing <a href="https://sourceforge.net/projects/vcxsrv/" target="_blank" rel="noopener">vcXsrv</a> on the Windows 10 which hosts your WSL. </p>
<div align=center><img src="/lib/mesa/glxgears.png" class="" title="glx demo"></div>

<p>This time I still choose the gallium-xlib with softpipe. The following call graph shows the path that GLX context is created.</p>
<div align=center><img src="/lib/mesa/glXCreateContext.png" class="" title="glx context creation"></div>

<p>As we know, Mesa is quite modularized and flexible. How does it take the path that <code>softpipe_create_context</code> rather than other pipe contexts? The <a href="https://gitlab.freedesktop.org/mesa/mesa/blob/master/src/gallium/include/state_tracker/st_api.h" target="_blank" rel="noopener">st_manager</a> is a key structure.</p>
<p><code>struct pipe_screen</code> has a callback function that will be set to <code>softpipe_create_context</code>. The following calls will create <code>struct pipe_screen</code> that will be set to the <code>st_manager</code>.</p>
<div align=center><img src="/lib/mesa/glXChooseVisual.png" class="" title="pipe_screen creation"></div>

<p>To bind the intended gallium driver backend to Mesa there must be something done before <code>glXChooseVisual</code> is called. It’s started by the library <code>init()</code> and prepare the global variables.</p>
<p><a href="https://gitlab.freedesktop.org/mesa/mesa/blob/master/src/gallium/state_trackers/glx/xlib/xm_public.h" target="_blank" rel="noopener">xm_public.h</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This is the driver interface required by the glx/xlib state tracker. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xm_driver</span> &#123;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">pipe_screen</span> *(*<span class="title">create_pipe_screen</span>)( <span class="title">Display</span> *<span class="title">display</span> );</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">st_api</span> *(*<span class="title">create_st_api</span>)( <span class="title">void</span> );</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">void</span></span><br><span class="line">xmesa_set_driver( <span class="keyword">const</span> struct xm_driver *driver );</span><br></pre></td></tr></table></figure>
<p><a href="https://gitlab.freedesktop.org/mesa/mesa/blob/master/src/gallium/targets/libgl-xlib/xlib.c" target="_blank" rel="noopener">xlib.c</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Helper function to build a subset of a driver stack consisting of</span></span><br><span class="line"><span class="comment"> * one of the software rasterizers (llvmpipe, softpipe) and the</span></span><br><span class="line"><span class="comment"> * xlib winsys.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_screen</span> *</span></span><br><span class="line"><span class="class"><span class="title">swrast_xlib_create_screen</span>( <span class="title">Display</span> *<span class="title">display</span> )</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">sw_winsys</span> *<span class="title">winsys</span>;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">pipe_screen</span> *<span class="title">screen</span> = <span class="title">NULL</span>;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/* Create the underlying winsys, which performs presents to Xlib</span></span><br><span class="line"><span class="comment">    * drawables:</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   winsys = xlib_create_sw_winsys( <span class="built_in">display</span> );</span><br><span class="line">   <span class="keyword">if</span> (winsys == <span class="literal">NULL</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* Create a software rasterizer on top of that winsys:</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   screen = sw_screen_create( winsys );</span><br><span class="line">   <span class="keyword">if</span> (screen == <span class="literal">NULL</span>)</span><br><span class="line">      <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* Inject any wrapping layers we want to here:</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">return</span> debug_screen_wrap( screen );</span><br><span class="line"></span><br><span class="line">fail:</span><br><span class="line">   <span class="keyword">if</span> (winsys)</span><br><span class="line">      winsys-&gt;destroy( winsys );</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">xm_driver</span> <span class="title">xlib_driver</span> = </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   .create_pipe_screen = swrast_xlib_create_screen,</span><br><span class="line">   .create_st_api = st_gl_api_create,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Build the rendering stack.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> The obsolete symbols _init and _fini</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * signature:</span></span><br><span class="line"><span class="comment"> * void _init(void);</span></span><br><span class="line"><span class="comment"> * void _fini(void);</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The linker recoginizes special symbols _init and _fini. If a dynamic library</span></span><br><span class="line"><span class="comment"> * exports a routine named _init, then that code is executed after the loading,</span></span><br><span class="line"><span class="comment"> * before dlopen() returns. If the dynamic library exports a routine named _fini,</span></span><br><span class="line"><span class="comment"> * then that routine is called just before the library is unloaded. In case you</span></span><br><span class="line"><span class="comment"> * need to avoid linking against the system startup files,this can be done by</span></span><br><span class="line"><span class="comment"> * giving gcc the "-nostartfiles" parameter on the command line.</span></span><br><span class="line"><span class="comment"> * Using these routines, or the gcc -nostartfiles of -nostdlib options, is not</span></span><br><span class="line"><span class="comment"> * recommended. Their use may result in undesired behavior, since the constructor/</span></span><br><span class="line"><span class="comment"> * destructor routines will not be executed(unless special measures are taken).</span></span><br><span class="line"><span class="comment"> * Instead, libraries should export routines using the __attribute__((constructor))</span></span><br><span class="line"><span class="comment"> * and __attribute__((destructor)) function attributes. Constructor routines are</span></span><br><span class="line"><span class="comment"> * executed before dlopen() returns, and destructor routines ared executed before</span></span><br><span class="line"><span class="comment"> * dlclose() returns.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _init( <span class="keyword">void</span> ) __attribute__((constructor));</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _init( <span class="keyword">void</span> )</span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">/* Initialize the xlib libgl code, pass in the winsys:</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   xmesa_set_driver( &amp;xlib_driver );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>where define the <code>xlib_driver</code> and set by <code>_init()</code>.</p>
<p><a href="https://gitlab.freedesktop.org/mesa/mesa/blob/master/src/gallium/auxiliary/target-helpers/sw_helper.h" target="_blank" rel="noopener">sw_helper.h</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_screen</span> *</span></span><br><span class="line"><span class="class"><span class="title">sw_screen_create_named</span>(<span class="title">struct</span> <span class="title">sw_winsys</span> *<span class="title">winsys</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">driver</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">pipe_screen</span> *<span class="title">screen</span> = <span class="title">NULL</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(GALLIUM_LLVMPIPE)</span></span><br><span class="line">   <span class="keyword">if</span> (screen == <span class="literal">NULL</span> &amp;&amp; <span class="built_in">strcmp</span>(driver, <span class="string">"llvmpipe"</span>) == <span class="number">0</span>)</span><br><span class="line">      screen = llvmpipe_create_screen(winsys);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(GALLIUM_VIRGL)</span></span><br><span class="line">   <span class="keyword">if</span> (screen == <span class="literal">NULL</span> &amp;&amp; <span class="built_in">strcmp</span>(driver, <span class="string">"virpipe"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">virgl_winsys</span> *<span class="title">vws</span>;</span></span><br><span class="line">      vws = virgl_vtest_winsys_wrap(winsys);</span><br><span class="line">      screen = virgl_create_screen(vws, <span class="literal">NULL</span>);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(GALLIUM_SOFTPIPE)</span></span><br><span class="line">   <span class="keyword">if</span> (screen == <span class="literal">NULL</span> &amp;&amp; <span class="built_in">strcmp</span>(driver, <span class="string">"softpipe"</span>) == <span class="number">0</span>)</span><br><span class="line">      screen = softpipe_create_screen(winsys);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(GALLIUM_SWR)</span></span><br><span class="line">   <span class="keyword">if</span> (screen == <span class="literal">NULL</span> &amp;&amp; <span class="built_in">strcmp</span>(driver, <span class="string">"swr"</span>) == <span class="number">0</span>)</span><br><span class="line">      screen = swr_create_screen(winsys);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(GALLIUM_ZINK)</span></span><br><span class="line">   <span class="keyword">if</span> (screen == <span class="literal">NULL</span> &amp;&amp; <span class="built_in">strcmp</span>(driver, <span class="string">"zink"</span>) == <span class="number">0</span>)</span><br><span class="line">      screen = zink_create_screen(winsys);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> screen;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_screen</span> *</span></span><br><span class="line"><span class="class"><span class="title">sw_screen_create</span>(<span class="title">struct</span> <span class="title">sw_winsys</span> *<span class="title">winsys</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span> *default_driver;</span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span> *driver;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(GALLIUM_LLVMPIPE)</span></span><br><span class="line">   default_driver = <span class="string">"llvmpipe"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(GALLIUM_SOFTPIPE)</span></span><br><span class="line">   default_driver = <span class="string">"softpipe"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(GALLIUM_SWR)</span></span><br><span class="line">   default_driver = <span class="string">"swr"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(GALLIUM_ZINK)</span></span><br><span class="line">   default_driver = <span class="string">"zink"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">   default_driver = <span class="string">""</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">   driver = debug_get_option(<span class="string">"GALLIUM_DRIVER"</span>, default_driver);</span><br><span class="line">   <span class="keyword">return</span> sw_screen_create_named(winsys, driver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://gitlab.freedesktop.org/mesa/mesa/blob/master/src/gallium/state_trackers/glx/xlib/xm_api.c" target="_blank" rel="noopener">xm_api.c</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Driver interface routines, set up by xlib backend on library</span></span><br><span class="line"><span class="comment"> * _init().  These are global in the same way that function names are</span></span><br><span class="line"><span class="comment"> * global.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">xm_driver</span> <span class="title">driver</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">st_api</span> *<span class="title">stapi</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">xmesa_set_driver</span><span class="params">( <span class="keyword">const</span> struct xm_driver *templ )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   driver = *templ;</span><br><span class="line">   stapi = driver.create_st_api();</span><br><span class="line"></span><br><span class="line">   xmesa_strict_invalidate =</span><br><span class="line">      debug_get_bool_option(<span class="string">"XMESA_STRICT_INVALIDATE"</span>, FALSE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> XMesaDisplay</span><br><span class="line">xmesa_init_display( Display *<span class="built_in">display</span> )</span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">static</span> <span class="keyword">mtx_t</span> init_mutex = _MTX_INITIALIZER_NP;</span><br><span class="line">   XMesaDisplay xmdpy;</span><br><span class="line">   XMesaExtDisplayInfo *info;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">display</span> == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   mtx_lock(&amp;init_mutex);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* Look for XMesaDisplay which corresponds to this display */</span></span><br><span class="line">   info = MesaExtInfo.head;</span><br><span class="line">   <span class="keyword">while</span>(info) &#123;</span><br><span class="line">      <span class="keyword">if</span> (info-&gt;<span class="built_in">display</span> == <span class="built_in">display</span>) &#123;</span><br><span class="line">         <span class="comment">/* Found it */</span></span><br><span class="line">         mtx_unlock(&amp;init_mutex);</span><br><span class="line">         <span class="keyword">return</span>  &amp;info-&gt;mesaDisplay;</span><br><span class="line">      &#125;</span><br><span class="line">      info = info-&gt;next;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* Not found.  Create new XMesaDisplay */</span></span><br><span class="line">   <span class="comment">/* first allocate X-related resources and hook destroy callback */</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/* allocate mesa display info */</span></span><br><span class="line">   info = (XMesaExtDisplayInfo *) Xmalloc(<span class="keyword">sizeof</span>(XMesaExtDisplayInfo));</span><br><span class="line">   <span class="keyword">if</span> (info == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      mtx_unlock(&amp;init_mutex);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   info-&gt;<span class="built_in">display</span> = <span class="built_in">display</span>;</span><br><span class="line"></span><br><span class="line">   xmdpy = &amp;info-&gt;mesaDisplay; <span class="comment">/* to be filled out below */</span></span><br><span class="line">   xmdpy-&gt;<span class="built_in">display</span> = <span class="built_in">display</span>;</span><br><span class="line">   xmdpy-&gt;pipe = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">   xmdpy-&gt;smapi = CALLOC_STRUCT(st_manager);</span><br><span class="line">   <span class="keyword">if</span> (!xmdpy-&gt;smapi) &#123;</span><br><span class="line">      Xfree(info);</span><br><span class="line">      mtx_unlock(&amp;init_mutex);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   xmdpy-&gt;screen = driver.create_pipe_screen(<span class="built_in">display</span>);</span><br><span class="line">   <span class="keyword">if</span> (!xmdpy-&gt;screen) &#123;</span><br><span class="line">      <span class="built_in">free</span>(xmdpy-&gt;smapi);</span><br><span class="line">      Xfree(info);</span><br><span class="line">      mtx_unlock(&amp;init_mutex);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* At this point, both smapi and screen are known to be valid */</span></span><br><span class="line">   xmdpy-&gt;smapi-&gt;screen = xmdpy-&gt;screen;</span><br><span class="line">   xmdpy-&gt;smapi-&gt;get_param = xmesa_get_param;</span><br><span class="line">   (<span class="keyword">void</span>) mtx_init(&amp;xmdpy-&gt;mutex, mtx_plain);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* chain to the list of displays */</span></span><br><span class="line">   _XLockMutex(_Xglobal_lock);</span><br><span class="line">   info-&gt;next = MesaExtInfo.head;</span><br><span class="line">   MesaExtInfo.head = info;</span><br><span class="line">   MesaExtInfo.ndisplays++;</span><br><span class="line">   _XUnlockMutex(_Xglobal_lock);</span><br><span class="line"></span><br><span class="line">   mtx_unlock(&amp;init_mutex);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> xmdpy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>where <code>driver.create_pipe_screen(display)</code> is instantiated as <code>xlib_driver.swrast_xlib_create_screen</code>. As we see, the dynamic library routine <code>_init()</code> will set <code>xlib_driver.create_pipe_screen</code> to <code>swrast_xlib_create_screen</code> that return a <code>pipe_screen</code> to be set to the <code>st_manager-&gt;screen</code>. Eventually those two helper functions decide which gallium driver backend will be used by compilation macros.</p>
<h2 id="Gallium-Genbu"><a href="#Gallium-Genbu" class="headerlink" title="Gallium Genbu"></a>Gallium Genbu</h2><p>To verify the analysis above we will try to add a customized gallium driver named <strong>genbu</strong> as a clone from the existing softpipe based GLX. All that we will do is three parts work below.</p>
<ul>
<li>key data structures: genbu_screen, genbu_context, the related callbacks and definitions </li>
<li>helper functions for loading software rasterizers for GLX</li>
<li>build scripts</li>
</ul>
<h3 id="Added-or-Modified-Sources-and-Build-Scripts"><a href="#Added-or-Modified-Sources-and-Build-Scripts" class="headerlink" title="Added or Modified Sources and Build Scripts"></a><a href="https://gitlab.freedesktop.org/lucmaa/mesa/tree/gallium-gb-1.0" target="_blank" rel="noopener">Added or Modified Sources and Build Scripts</a></h3><h3 id="Trace"><a href="#Trace" class="headerlink" title="Trace"></a>Trace</h3><div class="table-container">
<table>
<thead>
<tr>
<th><em>belong</em></th>
<th><em>hook</em></th>
<th><em>callback</em></th>
<th><em>caller</em></th>
<th><em>X/GL API</em></th>
</tr>
</thead>
<tbody>
<tr>
<td>pipe_screen</td>
<td>resource_create</td>
<td>softpipe_resource_create</td>
<td>bufferobj_data</td>
<td></td>
</tr>
<tr>
<td>pipe_context</td>
<td>transfer_map</td>
<td>softpipe_transfer_map</td>
<td></td>
<td></td>
</tr>
<tr>
<td>pipe_context</td>
<td>create_surface</td>
<td>softpipe_create_surface</td>
<td>st_framebuffer_validate</td>
<td></td>
</tr>
<tr>
<td>pipe_context</td>
<td>flush</td>
<td>softpipe_flush_wrapped</td>
<td>st_context_flush</td>
<td>glXSwapBuffers</td>
</tr>
<tr>
<td>pipe_context</td>
<td>clear</td>
<td>softpipe_clear</td>
<td>st_Clear</td>
<td>glClear</td>
</tr>
<tr>
<td>pipe_context</td>
<td>draw_vbo</td>
<td>softpipe_draw_vbo</td>
<td>st_draw_vbo</td>
<td>glCallList</td>
</tr>
<tr>
<td>pipe_context</td>
<td>draw_vbo</td>
<td>softpipe_draw_vbo</td>
<td>st_draw_vbo</td>
<td>glCallList</td>
</tr>
</tbody>
</table>
</div>
<h2 id="DRI-Based-GLX-Demos"><a href="#DRI-Based-GLX-Demos" class="headerlink" title="DRI-Based GLX Demos"></a>DRI-Based GLX Demos</h2><h3 id="Loading"><a href="#Loading" class="headerlink" title="Loading"></a>Loading</h3><ul>
<li><code>__glXInitialize</code></li>
<li><code>driOpenDriver</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(GLX_DIRECT_RENDERING) &amp;&amp; !defined(GLX_USE_APPLEGL)</span></span><br><span class="line">   glx_direct = !env_var_as_boolean(<span class="string">"LIBGL_ALWAYS_INDIRECT"</span>, <span class="literal">false</span>);</span><br><span class="line">   glx_accel = !env_var_as_boolean(<span class="string">"LIBGL_ALWAYS_SOFTWARE"</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">   dpyPriv-&gt;drawHash = __glxHashCreate();</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ** Initialize the direct rendering per display data and functions.</span></span><br><span class="line"><span class="comment">    ** Note: This _must_ be done before calling any other DRI routines</span></span><br><span class="line"><span class="comment">    ** (e.g., those called in AllocAndFetchScreenConfigs).</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(GLX_USE_DRM)</span></span><br><span class="line">   <span class="keyword">if</span> (glx_direct &amp;&amp; glx_accel) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(HAVE_DRI3)</span></span><br><span class="line">      <span class="keyword">if</span> (!env_var_as_boolean(<span class="string">"LIBGL_DRI3_DISABLE"</span>, <span class="literal">false</span>))</span><br><span class="line">         dpyPriv-&gt;dri3Display = dri3_create_display(dpy);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* HAVE_DRI3 */</span></span></span><br><span class="line">      dpyPriv-&gt;dri2Display = dri2CreateDisplay(dpy);</span><br><span class="line">      dpyPriv-&gt;driDisplay = driCreateDisplay(dpy);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* GLX_USE_DRM */</span></span></span><br><span class="line">   <span class="keyword">if</span> (glx_direct)</span><br><span class="line">      dpyPriv-&gt;driswDisplay = driswCreateDisplay(dpy);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* GLX_DIRECT_RENDERING &amp;&amp; !GLX_USE_APPLEGL */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> GLX_USE_APPLEGL</span></span><br><span class="line">   <span class="keyword">if</span> (!applegl_create_display(dpyPriv)) &#123;</span><br><span class="line">      <span class="built_in">free</span>(dpyPriv);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> GLX_USE_WINDOWSGL</span></span><br><span class="line">   <span class="keyword">if</span> (glx_direct &amp;&amp; glx_accel)</span><br><span class="line">      dpyPriv-&gt;windowsdriDisplay = driwindowsCreateDisplay(dpy);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!AllocAndFetchScreenConfigs(dpy, dpyPriv)) &#123;</span><br><span class="line">      <span class="built_in">free</span>(dpyPriv);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>This process of loading drivers works similarly with that of gallium-based glx. Compilation macros and environment variables make a difference. There are several approaches to load the specific drivers:</p>
<ul>
<li><code>dri3_create_display</code></li>
<li><code>dri2CreateDisplay</code></li>
<li><code>driCreateDisplay</code></li>
<li><code>driswCreateDisplay</code></li>
<li><code>applegl_create_display</code></li>
<li><code>driwindowsCreateDisplay</code></li>
</ul>
<p>Let’s look into <code>driCreateDisplay</code>. Once it manages to attach to <code>driCreateScreen</code> which searches and matches the appropriate gallium driver the function <code>driOpenDriver</code> will open the <strong>found</strong> driver by its name like “i965”, “radeon”, “nouveau”, etc. These drivers are supposed to be installed at <strong><code>LIBGL_DRIVERS_PATH</code></strong> or <code>LIBGL_DRIVERS_DIR</code>(deprecated) and named as <code>*_dri.so</code> by default.</p>
<p>Like Gallium-based GLX’s <code>_init</code> routine with GCC <strong><code>constructor</code></strong> attribute, DRI-based GLX also defines a routine <code>megadriver_stub_init</code> with <code>constructor</code> attribute which allows to load the specific driver in a way of <strong><code>__DRIextension</code></strong>.</p>
<div align=center><img src="/lib/mesa/gdb.svg" class="" title="osdemo"></div>


<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This is a constructor function for the megadriver dynamic library.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * When the driver is dlopen'ed, this function will run. It will</span></span><br><span class="line"><span class="comment"> * search for the name of the foo_dri.so file that was opened using</span></span><br><span class="line"><span class="comment"> * the dladdr function.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * After finding foo's name, it will call __driDriverGetExtensions_foo</span></span><br><span class="line"><span class="comment"> * and use the return to update __driDriverExtensions to enable</span></span><br><span class="line"><span class="comment"> * compatibility with older DRI driver loaders.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">__attribute__((constructor)) <span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">megadriver_stub_init(<span class="keyword">void</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Allocate, initialize and return a __DRIdisplayPrivate object.</span></span><br><span class="line"><span class="comment"> * This is called from __glXInitialize() when we are given a new</span></span><br><span class="line"><span class="comment"> * display pointer.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">_X_HIDDEN __GLXDRIdisplay *</span><br><span class="line">driCreateDisplay(Display * dpy)</span><br><span class="line">&#123;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">dri_display</span> *<span class="title">pdpyp</span>;</span></span><br><span class="line">   <span class="keyword">int</span> eventBase, errorBase;</span><br><span class="line">   <span class="keyword">int</span> major, minor, patch;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!XF86DRIQueryExtension(dpy, &amp;eventBase, &amp;errorBase)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!XF86DRIQueryVersion(dpy, &amp;major, &amp;minor, &amp;patch)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   pdpyp = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span> *pdpyp);</span><br><span class="line">   <span class="keyword">if</span> (!pdpyp) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   pdpyp-&gt;driMajor = major;</span><br><span class="line">   pdpyp-&gt;driMinor = minor;</span><br><span class="line">   pdpyp-&gt;driPatch = patch;</span><br><span class="line"></span><br><span class="line">   pdpyp-&gt;base.destroyDisplay = driDestroyDisplay;</span><br><span class="line">   pdpyp-&gt;base.createScreen = driCreateScreen;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> &amp;pdpyp-&gt;base;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Contexts"><a href="#Contexts" class="headerlink" title="Contexts"></a>Contexts</h2><p>There are a variety of <strong>contexts</strong> in Mesa. They are designed as a framework of layers.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">__________________</span><br><span class="line">|                |</span><br><span class="line">|   gl_contex    | --------------&gt; standard &amp; general</span><br><span class="line">|________________|</span><br><span class="line"></span><br><span class="line">__________________</span><br><span class="line">|                |</span><br><span class="line">|   st_contex    | --------------&gt; adapter</span><br><span class="line">|________________|</span><br><span class="line"></span><br><span class="line">__________________</span><br><span class="line">|                |</span><br><span class="line">|  draw_contex   | --------------&gt; driver-specific</span><br><span class="line">|________________|</span><br></pre></td></tr></table></figure>
<h3 id="gl-context"><a href="#gl-context" class="headerlink" title="gl_context"></a>gl_context</h3><blockquote><p>This is the central context data structure for Mesa. Almost all OpenGL state is contained in this structure. Think of this as a base class from which device drivers will derive sub classes.</p>
</blockquote>
<p>Apart from OpenGL state it contains several other contexts</p>
<ul>
<li><code>swrast_context</code></li>
<li><code>swsetup_context</code></li>
<li><code>swtnl_context</code></li>
<li><code>vbo_context</code></li>
<li><code>st_context</code></li>
</ul>
<h3 id="st-context"><a href="#st-context" class="headerlink" title="st_context"></a>st_context</h3><h3 id="draw-context"><a href="#draw-context" class="headerlink" title="draw_context"></a>draw_context</h3><h3 id="vbo-context"><a href="#vbo-context" class="headerlink" title="vbo_context"></a>vbo_context</h3><p>VBO is short for vertex buffer object. This context derives two kinds of vbo contexts, <code>vbo_exec_context</code> and <code>vbo_save_context</code> which <code>vbo_exec_context</code> is generic for core and compatible ogl and the other is specific for compatible ogl.</p>
<h4 id="vbo-exec-vtx-init"><a href="#vbo-exec-vtx-init" class="headerlink" title="vbo_exec_vtx_init"></a>vbo_exec_vtx_init</h4><ul>
<li>Allocate a <code>gl_buffer_object</code> which just is referenced.</li>
<li>Initialize vbo attributes including size, type and active size.</li>
</ul>
<h4 id="vbo-vs-vao"><a href="#vbo-vs-vao" class="headerlink" title="vbo vs. vao"></a>vbo vs. vao</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gl_buffer_object</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   GLint RefCount;</span><br><span class="line">   GLuint Name;</span><br><span class="line">   GLchar *Label;       </span><br><span class="line">   GLenum16 Usage;      </span><br><span class="line">   GLbitfield StorageFlags; </span><br><span class="line">   GLsizeiptrARB Size;  </span><br><span class="line">   GLubyte *Data;       </span><br><span class="line">   GLboolean DeletePending;   </span><br><span class="line">   GLboolean Written;   </span><br><span class="line">   GLboolean Purgeable; </span><br><span class="line">   GLboolean Immutable; </span><br><span class="line">   gl_buffer_usage UsageHistory; </span><br><span class="line">   GLuint NumSubDataCalls;</span><br><span class="line">   GLuint NumMapBufferWriteCalls;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">gl_buffer_mapping</span> <span class="title">Mappings</span>[<span class="title">MAP_COUNT</span>];</span></span><br><span class="line">   <span class="keyword">simple_mtx_t</span> MinMaxCacheMutex;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">hash_table</span> *<span class="title">MinMaxCache</span>;</span></span><br><span class="line">   <span class="keyword">unsigned</span> MinMaxCacheHitIndices;</span><br><span class="line">   <span class="keyword">unsigned</span> MinMaxCacheMissIndices;</span><br><span class="line">   <span class="keyword">bool</span> MinMaxCacheDirty;</span><br><span class="line">   <span class="keyword">bool</span> HandleAllocated; </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gl_vertex_array_object</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   GLuint Name;</span><br><span class="line">   GLint RefCount;</span><br><span class="line">   GLchar *Label;       </span><br><span class="line">   GLboolean EverBound;</span><br><span class="line">   <span class="keyword">bool</span> SharedAndImmutable;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">gl_array_attributes</span> <span class="title">VertexAttrib</span>[<span class="title">VERT_ATTRIB_MAX</span>];</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">gl_vertex_buffer_binding</span> <span class="title">BufferBinding</span>[<span class="title">VERT_ATTRIB_MAX</span>];</span></span><br><span class="line">   GLbitfield VertexAttribBufferMask;</span><br><span class="line">   GLbitfield Enabled;</span><br><span class="line">   GLbitfield _EffEnabledVBO;</span><br><span class="line">   gl_attribute_map_mode _AttributeMapMode;</span><br><span class="line">   GLbitfield NewArrays;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">gl_buffer_object</span> *<span class="title">IndexBufferObj</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Dispatchers"><a href="#Dispatchers" class="headerlink" title="Dispatchers"></a>Dispatchers</h2><ul>
<li><em><code>Exec</code></em>: The current dispatch table for non-displaylist-saving execution, either BeginEnd or OutsideBeginEnd</li>
<li><em><code>OutsideBeginEnd</code></em>: The normal dispatch table for non-displaylist-saving, non-begin/end</li>
<li><em><code>Save</code></em>: The dispatch table used between glNewList() and glEndList()</li>
<li><em><code>BeginEnd</code></em>: The dispatch table used between glBegin() and glEnd() (outside of a display list). Only valid functions between those two are set, which is mostly just the set in a GLvertexformat struct.</li>
<li><em><code>ContextLost</code></em>: Dispatch table for when a graphics reset has happened.</li>
<li><em><code>MarshalExec</code></em>: Dispatch table used to marshal API calls from the client program to a separate server thread. NULL if API calls are not being marshalled to another thread.</li>
<li><em><code>CurrentClientDispatch</code></em>: Dispatch table currently in use for fielding API calls from the client program. If API calls are being marshalled to another thread, this refers to <em><code>MarshalExec</code></em>. Otherwise it refers to <em><code>CurrentServerDispatch</code></em>.</li>
<li><em><code>CurrentServerDispatch</code></em>: Dispatch table currently in use for performing API calls. It refers to <em><code>Save</code></em> or <em><code>Exec</code></em>.</li>
</ul>
<h2 id="Modules"><a href="#Modules" class="headerlink" title="Modules"></a>Modules</h2><ul>
<li>draw module</li>
<li>CSO module</li>
<li>translate module</li>
<li>VBO module</li>
<li>TNL module(Transform &amp; Light)</li>
</ul>
<h2 id="draw-xxx-stage"><a href="#draw-xxx-stage" class="headerlink" title="draw_xxx_stage"></a>draw_xxx_stage</h2><ul>
<li><strong><code>extern struct draw_stage *draw_unfilled_stage( struct draw_context *context );</code></strong></li>
<li><strong><code>extern struct draw_stage *draw_twoside_stage( struct draw_context *context );</code></strong></li>
<li><strong><code>extern struct draw_stage *draw_offset_stage( struct draw_context *context );</code></strong></li>
<li><strong><code>extern struct draw_stage *draw_clip_stage( struct draw_context *context );</code></strong></li>
<li><strong><code>extern struct draw_stage *draw_flatshade_stage( struct draw_context *context );</code></strong></li>
<li><strong><code>extern struct draw_stage *draw_cull_stage( struct draw_context *context );</code></strong></li>
<li><strong><code>extern struct draw_stage *draw_stipple_stage( struct draw_context *context );</code></strong></li>
<li><strong><code>extern struct draw_stage *draw_wide_line_stage( struct draw_context *context );</code></strong></li>
<li><strong><code>extern struct draw_stage *draw_wide_point_stage( struct draw_context *context );</code></strong></li>
<li><strong><code>extern struct draw_stage *draw_validate_stage( struct draw_context *context );</code></strong></li>
</ul>
<h2 id="Auxiliary"><a href="#Auxiliary" class="headerlink" title="Auxiliary"></a>Auxiliary</h2><ul>
<li><p>cso_cache<br>  The CSO cache is used to accelerate preparation of state by saving driver-specific state structure for later use.</p>
</li>
<li><p>draw<br>  Draw is a software TCL pipeline for hardware that lacks vertex shaders or other essential parts of pre-rasterization vertex preparation.</p>
</li>
<li><p>driver_ddebug</p>
</li>
<li>driver_noop</li>
<li>driver_rbug</li>
<li>driver_trace</li>
<li>gallivm</li>
<li>hud</li>
<li><p>indices<br>  Indices provides tools for translating or generating element indices for use with element-based rendering.</p>
</li>
<li><p>nir</p>
</li>
<li><p>os</p>
<ul>
<li>memory allocation</li>
<li>simple message logging</li>
<li>obtaining run-time configuration option</li>
<li>threading primitives<br>The OS module contains the abstraction for basic operating system services above. This is the bare minimum required to port Gallium to a new platform. It already provides the implementations of these abstractions for the most common platforms. When targeting an embedded platform no implementation will be provided - these must be provided separately.</li>
</ul>
</li>
<li><p>pipe-loader</p>
</li>
<li>pipebuffer</li>
<li>postprocess</li>
<li>rbug</li>
<li>renderonly</li>
<li>rtasm</li>
<li>target-helpers</li>
<li>tgsi</li>
<li>translate</li>
<li>util</li>
<li>vl</li>
</ul>
<h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h2><h4 id="When-xlib-creates-pipe-screen-only-software-rasterizers-or-pipes’screen-are-created-And-llvmpipe-softpipe-virgl-swr-unexceptionally-are-software-rasterizers-or-virtual-GPU-Zink-is-in-brief-a-translator-from-OpenGL-to-Vulkan-and-implemented-as-Gallium-driver-So-why-only-software-pipes"><a href="#When-xlib-creates-pipe-screen-only-software-rasterizers-or-pipes’screen-are-created-And-llvmpipe-softpipe-virgl-swr-unexceptionally-are-software-rasterizers-or-virtual-GPU-Zink-is-in-brief-a-translator-from-OpenGL-to-Vulkan-and-implemented-as-Gallium-driver-So-why-only-software-pipes" class="headerlink" title="When xlib creates pipe screen, only software rasterizers or pipes’screen are created. And llvmpipe, softpipe, virgl, swr, unexceptionally, are software rasterizers or virtual GPU. Zink is, in brief, a translator from OpenGL to Vulkan and implemented as Gallium driver. So why only software pipes?"></a>When xlib creates pipe screen, <em>only</em> software rasterizers or pipes’screen are created. And llvmpipe, softpipe, virgl, swr, unexceptionally, are software rasterizers or virtual GPU. <a href="https://www.collabora.com/news-and-blog/blog/2018/10/31/introducing-zink-opengl-implementation-vulkan/" target="_blank" rel="noopener">Zink</a> is, in brief, a translator from OpenGL to Vulkan and implemented as Gallium driver. So why only software pipes?</h4><p>The answer is <strong><code>sw_winsys</code></strong>. All of target helpers’s parameter is a <code>sw_winsys</code>. Check mesa source directory: <a href="https://gitlab.freedesktop.org/mesa/mesa/tree/master/src/gallium/winsys" target="_blank" rel="noopener">mesa/src/gallium/winsys</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">amdgpu</span><br><span class="line">etnaviv</span><br><span class="line">freedreno</span><br><span class="line">i915</span><br><span class="line">iris</span><br><span class="line">kmsro</span><br><span class="line">lima</span><br><span class="line">nouveau</span><br><span class="line">panfrost</span><br><span class="line">radeon</span><br><span class="line">svga</span><br><span class="line">sw</span><br><span class="line">tegra</span><br><span class="line">v3d</span><br><span class="line">vc4</span><br><span class="line">virgl</span><br></pre></td></tr></table></figure>
<p>To put it simply, specific driver corresponds to specific winsys. The <code>sw</code> is for software rasterizers. If you expect to create pipe screen for some driver else, you need to add another target helper with its winsys as parameter like: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">static inline struct pipe_screen *</span><br><span class="line">i915_screen_create_named(struct i915_drm_winsys *winsys, const char *driver)</span><br></pre></td></tr></table></figure>
<p>That means you have to declare a bunch of new interfaces from the top. So you’d better wrap the function to create specific driver’s winsys so that it can take a sw_winsys as its parameter like:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#if defined(GALLIUM_VIRGL)</span><br><span class="line">   if (screen &#x3D;&#x3D; NULL &amp;&amp; strcmp(driver, &quot;virpipe&quot;) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">      struct virgl_winsys *vws;</span><br><span class="line">      vws &#x3D; virgl_vtest_winsys_wrap(winsys);</span><br><span class="line">      screen &#x3D; virgl_create_screen(vws, NULL);</span><br><span class="line">   &#125;</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<h4 id="libGL-so-is-not-built-until-glx-option-is-enabled-in-meson-options-txt"><a href="#libGL-so-is-not-built-until-glx-option-is-enabled-in-meson-options-txt" class="headerlink" title="libGL.so is not built until glx option is enabled in meson_options.txt."></a>libGL.so is not built until glx option is enabled in <strong>meson_options.txt</strong>.</h4><p>Only with essential build-time dependencies for X11 installed and glx option configured is libGL.so built.</p>
<h4 id="What-role-do-DRM-DRI-and-Gallium-play-in-Mesa"><a href="#What-role-do-DRM-DRI-and-Gallium-play-in-Mesa" class="headerlink" title="What role do DRM, DRI and Gallium play in Mesa?"></a>What role do DRM, DRI and Gallium play in Mesa?</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">_libdrm_checks &#x3D; [</span><br><span class="line">  [&#39;intel&#39;, with_dri_i915 or with_gallium_i915],</span><br><span class="line">  [&#39;amdgpu&#39;, with_amd_vk or with_gallium_radeonsi],</span><br><span class="line">  [&#39;radeon&#39;, (with_gallium_radeonsi or with_dri_r100 or with_dri_r200 or</span><br><span class="line">              with_gallium_r300 or with_gallium_r600)],</span><br><span class="line">  [&#39;nouveau&#39;, (with_gallium_nouveau or with_dri_nouveau)],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>DRI and Gallium seem to be respectively different underlying implementation in Mesa. Moreover in term of swrast and i915, you have to choose either of both as you can read the following code snippet in meson.build. In fact DRI is more complicated and staler but Gallium is more smaller and simpler.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if with_dri_swrast and (with_gallium_softpipe or with_gallium_swr)</span><br><span class="line">  error(&#39;Only one swrast provider can be built&#39;)</span><br><span class="line">endif</span><br><span class="line">if with_dri_i915 and with_gallium_i915</span><br><span class="line">  error(&#39;Only one i915 provider can be built&#39;)</span><br><span class="line">endif</span><br></pre></td></tr></table></figure>
<h4 id="What-problems-are-encountered-when-you-build-mesa-on-the-WSL"><a href="#What-problems-are-encountered-when-you-build-mesa-on-the-WSL" class="headerlink" title="What problems are encountered when you build mesa on the WSL?"></a>What problems are encountered when you build mesa on the WSL?</h4><ul>
<li>dri based GLX requires shared-glapi</li>
<li>Gallium-xlib based GLX requires softpipe or llvmpipe<ul>
<li>means that <code>gallium-xlib</code> is supposed to only support software rasterizers(llvmpipe, softpipe) and virtual GPU(virgl, swr).<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">option(</span><br><span class="line">  &#39;glx&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;xlib&#39;,</span><br><span class="line">  choices : [&#39;auto&#39;, &#39;disabled&#39;, &#39;dri&#39;, &#39;xlib&#39;, &#39;gallium-xlib&#39;],</span><br><span class="line">  description : &#39;Build support for GLX platform&#39;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
In Mesa, glx is implemented in three ways:</li>
</ul>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>*-based</th>
<th>backend</th>
<th>window system</th>
</tr>
</thead>
<tbody>
<tr>
<td>dri-based</td>
<td>non-sw-pipes</td>
<td>*_drm_winsys</td>
</tr>
<tr>
<td>xlib</td>
<td>tnl</td>
<td>sw_winsys</td>
</tr>
<tr>
<td>gallium-based</td>
<td>softpipe/llvmpipe</td>
<td>sw_winsys</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>OSMesa gallium requires gallium softpipe or llvmpipe<ul>
<li>means if <code>osmesa</code> is configured as <code>gallium</code>, <code>gallium-drivers</code> must include <code>swrast</code> but the <code>classic</code> osmesa uses the fixed-functioned TNL by default.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">option(</span><br><span class="line">  &#39;osmesa&#39;,</span><br><span class="line">  type : &#39;combo&#39;,</span><br><span class="line">  value : &#39;gallium&#39;,</span><br><span class="line">  choices : [&#39;none&#39;, &#39;classic&#39;, &#39;gallium&#39;],</span><br><span class="line">  description : &#39;Build OSmesa.&#39;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>Cannot build GLX support without X11 platform support and at least one OpenGL API<ul>
<li>GLX, As the name suggests, is dedicated to X11 winsys.</li>
</ul>
</li>
</ul>
<h4 id="When-glXInitialize-creates-the-Display-only-driswCreateDisplay-returns-successfully-Both-of-dri2CreateDisplay-and-driCreateDisplay-failed"><a href="#When-glXInitialize-creates-the-Display-only-driswCreateDisplay-returns-successfully-Both-of-dri2CreateDisplay-and-driCreateDisplay-failed" class="headerlink" title="When __glXInitialize creates the Display, only driswCreateDisplay returns successfully. Both of dri2CreateDisplay and driCreateDisplay failed."></a>When <code>__glXInitialize</code> creates the <code>Display</code>, <strong>only</strong> <code>driswCreateDisplay</code> returns successfully. Both of <code>dri2CreateDisplay</code> and <code>driCreateDisplay</code> failed.</h4><ul>
<li>env: WSL on Windows 10 and with vcXsrv installed on the host as X server</li>
</ul>
<p>The cause of failure is that vcXsrv has no extensions with DRI or DRI2. This lack of X server extension fails <code>DRI2QueryExtension</code> and <code>XF86DRIQueryExtension</code> so that the loading of gallium driver is not invoked.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * XextAddDisplay - add a display to this extension</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">XExtDisplayInfo *<span class="title">XextAddDisplay</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    XExtensionInfo *extinfo,</span></span></span><br><span class="line"><span class="function"><span class="params">    Display *dpy,</span></span></span><br><span class="line"><span class="function"><span class="params">    _Xconst <span class="keyword">char</span> *ext_name,</span></span></span><br><span class="line"><span class="function"><span class="params">    XExtensionHooks *hooks,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> nevents,</span></span></span><br><span class="line"><span class="function"><span class="params">    XPointer data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    XExtDisplayInfo *dpyinfo;</span><br><span class="line"></span><br><span class="line">    dpyinfo = (XExtDisplayInfo *) Xmalloc (<span class="keyword">sizeof</span> (XExtDisplayInfo));</span><br><span class="line">    <span class="keyword">if</span> (!dpyinfo) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    dpyinfo-&gt;<span class="built_in">display</span> = dpy;</span><br><span class="line">    dpyinfo-&gt;data = data;</span><br><span class="line">    dpyinfo-&gt;codes = XInitExtension (dpy, ext_name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * if the server has the extension, then we can initialize the</span></span><br><span class="line"><span class="comment">     * appropriate function vectors</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (dpyinfo-&gt;codes) &#123;</span><br><span class="line">	<span class="keyword">int</span> i, j;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>, j = dpyinfo-&gt;codes-&gt;first_event; i &lt; nevents; i++, j++) &#123;</span><br><span class="line">	    XESetWireToEvent (dpy, j, hooks-&gt;wire_to_event);</span><br><span class="line">	    XESetEventToWire (dpy, j, hooks-&gt;event_to_wire);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* register extension for XGE */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext_name, GE_NAME))</span><br><span class="line">            xgeExtRegister(dpy, dpyinfo-&gt;codes-&gt;major_opcode, hooks);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (hooks-&gt;create_gc)</span><br><span class="line">	  XESetCreateGC (dpy, dpyinfo-&gt;codes-&gt;extension, hooks-&gt;create_gc);</span><br><span class="line">	<span class="keyword">if</span> (hooks-&gt;copy_gc)</span><br><span class="line">	  XESetCopyGC (dpy, dpyinfo-&gt;codes-&gt;extension, hooks-&gt;copy_gc);</span><br><span class="line">	<span class="keyword">if</span> (hooks-&gt;flush_gc)</span><br><span class="line">	  XESetFlushGC (dpy, dpyinfo-&gt;codes-&gt;extension, hooks-&gt;flush_gc);</span><br><span class="line">	<span class="keyword">if</span> (hooks-&gt;free_gc)</span><br><span class="line">	  XESetFreeGC (dpy, dpyinfo-&gt;codes-&gt;extension, hooks-&gt;free_gc);</span><br><span class="line">	<span class="keyword">if</span> (hooks-&gt;create_font)</span><br><span class="line">	  XESetCreateFont (dpy, dpyinfo-&gt;codes-&gt;extension, hooks-&gt;create_font);</span><br><span class="line">	<span class="keyword">if</span> (hooks-&gt;free_font)</span><br><span class="line">	  XESetFreeFont (dpy, dpyinfo-&gt;codes-&gt;extension, hooks-&gt;free_font);</span><br><span class="line">	<span class="keyword">if</span> (hooks-&gt;close_display)</span><br><span class="line">	  XESetCloseDisplay (dpy, dpyinfo-&gt;codes-&gt;extension,</span><br><span class="line">			     hooks-&gt;close_display);</span><br><span class="line">	<span class="keyword">if</span> (hooks-&gt;error)</span><br><span class="line">	  XESetError (dpy, dpyinfo-&gt;codes-&gt;extension, hooks-&gt;error);</span><br><span class="line">	<span class="keyword">if</span> (hooks-&gt;error_string)</span><br><span class="line">	  XESetErrorString (dpy, dpyinfo-&gt;codes-&gt;extension,</span><br><span class="line">			    hooks-&gt;error_string);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hooks-&gt;close_display) &#123;</span><br><span class="line">	<span class="comment">/* The server doesn't have this extension.</span></span><br><span class="line"><span class="comment">	 * Use a private Xlib-internal extension to hang the close_display</span></span><br><span class="line"><span class="comment">	 * hook on so that the "cache" (extinfo-&gt;cur) is properly cleaned.</span></span><br><span class="line"><span class="comment">	 * (XBUG 7955)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	XExtCodes *codes = XAddExtension(dpy);</span><br><span class="line">	<span class="keyword">if</span> (!codes) &#123;</span><br><span class="line">	    XFree(dpyinfo);</span><br><span class="line">	    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	XESetCloseDisplay (dpy, codes-&gt;extension, hooks-&gt;close_display);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * now, chain it onto the list</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    _XLockMutex(_Xglobal_lock);</span><br><span class="line">    dpyinfo-&gt;next = extinfo-&gt;head;</span><br><span class="line">    extinfo-&gt;head = dpyinfo;</span><br><span class="line">    extinfo-&gt;cur = dpyinfo;</span><br><span class="line">    extinfo-&gt;ndisplays++;</span><br><span class="line">    _XUnlockMutex(_Xglobal_lock);</span><br><span class="line">    <span class="keyword">return</span> dpyinfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      </div>
      
      <footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/GL/">GL</a>
            </div>
        
        <nav class="post-nav"><a class="prev" href="/sys/windows-insider-program/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Windows Insider Program</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:lucmann@qq.com" class="iconfont icon-email" title="email"></a>
        <a href="https://github.com/lucmann" target="_blank" rel="noopener" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><script src='https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize("");    
    }
  </script><div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even" target="_blank" rel="noopener">Even</a>
  </span>

  <span class="copyright-year">&copy;2015 - 2021<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Luc</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>
