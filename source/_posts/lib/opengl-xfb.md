---
title: OpenGL Transform Feedback
date: 2021-05-08 09:04:30
tags: [GL]
categories: lib
---

# [Transform Feedback](https://www.khronos.org/opengl/wiki/Transform_Feedback)
**Transform Feedback**(xfb)是将Vertex_Processing阶段产生的图元数据保存在**Buffer Objects**, 以便后面多次提交。

<!--more-->

# [Vertex Processing](https://www.khronos.org/opengl/wiki/Vertex_Processing)
**xfb**的输入来自Vertex Processing, 所以首先要确定Vertex Processing阶段都是什么，输出什么。Vertex Processing的输出是图元(Primitives), 它至少包含一个vertex shader.

| Stage        | Presence       |
|:-------------|:---------------|
| vertex       | mandatory      |
| tessellation | optional       |
| geometry     | optional       |

# Capturing
{% blockquote %}
Transform Feedback is the process of capturing Primitives generated by the Vertex Processing step(s).
{% endblockquote %}

## Capturing Setting
```
void glTransformFeedbackVaryings(GLuint program,
				 GLsizei count,
				 const char **varyings,
				 GLenum bufferMode);
```

这个API设置:
- 哪些program的输出变量被**captured**
- capturing模式， capturing模式有两种
	- `GL_INTERLEAVED_ATTRIBS`
	- `GL_SEPARATE_ATTRIBS`

### interleaved mode
这种模式下，所有captured的输出被保存在同一个buffer object.

### separate mode
这种模式下，输出未必被captured到不同的buffer object, 它仅仅是指输出被captured到不同的**buffer binding points**. 因为同一个buffer object的不同区域也可以被绑定到不同的**buffer binding points**.

## Captured Output Variables
既然要capture Vertex Processing step(s)的输出变量，那么有两个问题:
- How many output variables and total components can be captured?
- Which types of output variables can be captured?

### Limitations for the Number
- separate capture

| Limitation                                       | Minimal Value |
|:-------------------------------------------------|:-------------:|
| GL_MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS       | 4             |
| GL_MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS    | 4             |

- interleaved capture

| Limitation                                       | Minimal Value |
|:-------------------------------------------------|:-------------:|
| GL_MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS | 64            |

- advanced interleaved capture (不同的变量放在不同的buffers)

| Limitation                                       | Minimal Value |
|:-------------------------------------------------|:-------------:|
| GL_MAX_TRANSFORM_FEEDBACK_BUFFERS                | 64            |

注意到在interleaved capture mode下，没有变量个数的限制，原因是这里真正需要限制的不是要captured的变量的个数，而是保存这些变量的buffer的个数，在interleaved mode下，所有captured的变量都是保存在同一个buffer中的，所以不需要限制。而在separate
mode下，每个列出的变量是保存在各自不同的buffer中，所以需要对此有一个上限。所以这里`GL_MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS`的一个更好的名字应该是`GL_MAX_TRANSFORM_FEEDBACK_SEPARATE_BUFFERS`.

### No Limitations for the Type 
任何类型的输出变量都可以被captured, 包括
- structs
- arrays
- members of interface blocks

# Buffer Binding
当设置好要capturing program中的哪些输出变量，以何种模式captured后，接下来就要设置(申请)保存captured的数据的buffer objects.
